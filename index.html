# –ê–∫—Ç–∏–≤–∞—Ç–æ—Ä –í–µ–± –°–∞–π—Ç—É –ê–Ω—Ç–∏–∫–æ—Ä—É–ø—Ü—ñ—è (–û–Ω–æ–≤–ª–µ–Ω–∏–π ‚Äî —Å—É–º—ñ—Å–Ω—ñ—Å—Ç—å –ø—Ä–∏ –≤—ñ–¥—Å—É—Ç–Ω–æ—Å—Ç—ñ –º–æ–¥—É–ª—è ssl)
# ---------------------------------------------------------------------------------
# –û–ø–∏—Å:
# –¶–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω–∏–π –≥–æ–ª–æ–≤–Ω–∏–π —Ñ–∞–π–ª –∑–∞–ø—É—Å–∫—É –≤–µ–±—Å–∞–π—Ç—É —á–∞—Ç–±–æ—Ç–∞ ¬´–ê–Ω—Ç–∏–∫–æ—Ä—É–ø—Ü—ñ—è¬ª. –í—ñ–Ω –Ω–∞–º–∞–≥–∞—î—Ç—å—Å—è
# —ñ–º–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ FastAPI (–¥–ª—è –ø–æ–≤–Ω–æ—Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Ä–µ–∂–∏–º—É). –Ø–∫—â–æ —ñ–º–ø–æ—Ä—Ç –Ω–µ –≤–¥–∞—î—Ç—å—Å—è
# (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, —É —Å–µ—Ä–µ–¥–æ–≤–∏—â—ñ –±–µ–∑ –º–æ–¥—É–ª—è `ssl` –∞–±–æ –±–µ–∑ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—Ö –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π), —Å–∫—Ä–∏–ø—Ç
# –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å —É "fallback" —Ä–µ–∂–∏–º ‚Äî –ø—Ä–æ—Å—Ç–∏–π HTTP-—Å–µ—Ä–≤–µ—Ä –Ω–∞ –±–∞–∑—ñ
# http.server, —è–∫–∏–π –Ω–∞–¥–∞—î –±–∞–∑–æ–≤–∏–π –≤–µ–±-—ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å —ñ –æ–±—Ä–æ–±–∫—É —Ñ–æ—Ä–º–∏ /ask.
#
# –ú–µ—Ç–∞: —É–Ω–∏–∫–Ω—É—Ç–∏ –ø–æ–º–∏–ª–∫–∏ `ModuleNotFoundError: No module named 'ssl'`, —è–∫–∞ –≤–∏–Ω–∏–∫–∞—î
# –ø—ñ–¥ —á–∞—Å —ñ–º–ø–æ—Ä—Ç—É FastAPI —É —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞—Ö –±–µ–∑ SSL-–ø—ñ–¥—Ç—Ä–∏–º–∫–∏. –£ production-—Ä—ñ—à–µ–Ω–Ω—ñ
# —Ä–µ–∫–æ–º–µ–Ω–¥—É—î–º–æ –≤–∏–ø—Ä–∞–≤–∏—Ç–∏ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ (–≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ openssl, –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ dev-–ø–∞–∫–µ—Ç–∏)
# —Ç–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —ñ–∑ –ø–æ–≤–Ω–æ—é Python-—ñ–Ω—Å—Ç–∞–ª—è—Ü—ñ—î—é.
#
# –Ø–∫ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏:
# - –Ø–∫—â–æ —É –≤–∞—Å —î –ø–æ–≤–Ω–∞ —Å–µ—Ä–µ–¥–∞ –∑ FastAPI ‚Äî –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏–º–µ—Ç—å—Å—è FastAPI + Jinja2.
# - –Ø–∫—â–æ FastAPI –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∏–π ‚Äî –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è –ø—Ä–æ—Å—Ç–∏–π HTTP-—Å–µ—Ä–≤–µ—Ä (–ø–æ—Ä—Ç –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º 8080).
# - –£ –æ–±–æ—Ö —Ä–µ–∂–∏–º–∞—Ö –≤–∏–∫–ª–∏–∫–∏ –¥–æ LLM (Gemini/OpenAI) —ñ –ø–æ—à—É–∫ —Ü–∏—Ç–∞—Ç –≤–∏–∫–æ–Ω—É—é—Ç—å—Å—è —á–µ—Ä–µ–∑
#   —Ñ—É–Ω–∫—Ü—ñ—ó-–æ–±–≥–æ—Ä—Ç–∫–∏ `call_llm_api_safe` —Ç–∞ `search_citations_safe`, —è–∫—ñ –Ω–∞–º–∞–≥–∞—é—Ç—å—Å—è
#   —ñ–º–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ —Ä–µ–∞–ª—å–Ω—ñ –º–æ–¥—É–ª—ñ. –Ø–∫—â–æ —ó—Ö –Ω–µ–º–∞—î ‚Äî –ø–æ–≤–µ—Ä—Ç–∞—é—Ç—å—Å—è –¥—Ä—É–∂–Ω—ñ –∑–∞–≥–ª—É—à–∫–∏.

import os
import sys
import threading
from pathlib import Path
from dotenv import load_dotenv
load_dotenv()

PORT = int(os.getenv('PORT', 8080))
TEMPLATES_DIR = Path(__file__).parent / 'templates'
STATIC_DIR = Path(__file__).parent / 'static'

# ---------------------------------
# –õ–µ–≥–∫—ñ –æ–±–≥–æ—Ä—Ç–∫–∏ –¥–ª—è –≤–∏–∫–ª–∏–∫—ñ–≤ LLM —ñ –ø–æ—à—É–∫—É
# ---------------------------------
# –ú–µ—Ç–∞: –Ω–µ —ñ–º–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ –≤–∞–∂–∫—ñ –º–æ–¥—É–ª—ñ –Ω–∞ —Ä—ñ–≤–Ω—ñ –º–æ–¥—É–ª—è (—â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –ø–æ–º–∏–ª–∫–∏ –ø—Ä–∏ —ñ–º–ø–æ—Ä—Ç—ñ)

def call_llm_api_safe(prompt: str, provider: str = None) -> str:
    """–ù–∞–º–∞–≥–∞—î—Ç—å—Å—è –≤–∏–∫–ª–∏–∫–∞—Ç–∏ —Ä–µ–∞–ª—å–Ω–∏–π call_llm_api —ñ–∑ –º–æ–¥—É–ª—è API_–Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è_–ê–Ω—Ç–∏–∫–æ—Ä—É–ø—Ü—ñ—è.
    –Ø–∫—â–æ –º–æ–¥—É–ª—å –∞–±–æ —Ñ—É–Ω–∫—Ü—ñ—è –≤—ñ–¥—Å—É—Ç–Ω—ñ ‚Äî –ø–æ–≤–µ—Ä—Ç–∞—î –∑–∞–≥–ª—É—à–∫—É, —è–∫–∞ –ø–æ—è—Å–Ω—é—î, —â–æ LLM –Ω–µ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ."""
    provider = provider or os.getenv('LLM_PROVIDER', 'gemini')
    try:
        # –¥–∏–Ω–∞–º—ñ—á–Ω–∏–π —ñ–º–ø–æ—Ä—Ç ‚Äî –º–æ–∂–ª–∏–≤–∏–π, —è–∫—â–æ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ –º–∞—î –≤—Å—ñ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ
        spec_mod = __import__('API_–Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è_–ê–Ω—Ç–∏–∫–æ—Ä—É–ø—Ü—ñ—è')
        if hasattr(spec_mod, 'call_llm_api'):
            return spec_mod.call_llm_api(prompt, provider=provider)
        if hasattr(spec_mod, 'call_llm_api_api'):
            return spec_mod.call_llm_api_api(prompt, provider=provider)
        # —è–∫—â–æ —Ñ—É–Ω–∫—Ü—ñ—è –º–∞—î —ñ–Ω—à—É –Ω–∞–∑–≤—É ‚Äî —Å–ø—Ä–æ–±—É—î–º–æ —Ç–∏–ø–æ–≤—É
        if hasattr(spec_mod, 'call_llm_api'):
            return spec_mod.call_llm_api(prompt, provider=provider)
    except Exception as e:
        # –Ü–≥–Ω–æ—Ä—É—î–º–æ –ø–æ–º–∏–ª–∫–∏ —ñ–º–ø–æ—Ä—Ç—É —Ç–∞ –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—É –∑–∞–≥–ª—É—à–∫—É
        return ("[LLM-–∑–∞–≥–ª—É—à–∫–∞] –ú–æ–¥–µ–ª—å –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞ —É —Ü—å–æ–º—É —Å–µ—Ä–µ–¥–æ–≤–∏—â—ñ. "
                "–©–æ–± –∞–∫—Ç–∏–≤—É–≤–∞—Ç–∏ ‚Äî –ø–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –≤—Å—ñ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ (fastapi, anyio, ssl),\n"
                f"—Ç–∞ —â–æ –º–æ–¥—É–ª—å 'API_–Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è_–ê–Ω—Ç–∏–∫–æ—Ä—É–ø—Ü—ñ—è' –¥–æ—Å—Ç—É–ø–Ω–∏–π.\n–¢–µ—Ö–Ω—ñ—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞: {e}")


def search_citations_safe(query: str, limit: int = 5):
    """–ù–∞–º–∞–≥–∞—î—Ç—å—Å—è –≤–∏–∫–æ–Ω–∞—Ç–∏ –ø–æ—à—É–∫ —á–µ—Ä–µ–∑ —ñ—Å–Ω—É—é—á–∏–π –º–æ–¥—É–ª—å —ñ–Ω–¥–µ–∫—Å–∞—Ü—ñ—ó. –Ø–∫—â–æ –π–æ–≥–æ –Ω–µ–º–∞—î ‚Äî –ø–æ–≤–µ—Ä—Ç–∞—î –ø–æ—Ä–æ–∂–Ω—ñ–π —Å–ø–∏—Å–æ–∫."""
    try:
        mod = __import__('API_–Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è_–ê–Ω—Ç–∏–∫–æ—Ä—É–ø—Ü—ñ—è')
        if hasattr(mod, 'search_citations'):
            return mod.search_citations(query, limit=limit)
    except Exception:
        # –°–ø—Ä–æ–±—É—î–º–æ —ñ–Ω—à—ñ —ñ–º–ø–æ—Ä—Ç–∏ (–Ω–∞–∑–≤–∏ –º–æ–¥—É–ª—ñ–≤, —è–∫—ñ –º–∏ –≥–µ–Ω–µ—Ä—É–≤–∞–ª–∏ —Ä–∞–Ω—ñ—à–µ)
        try:
            mod2 = __import__('–Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è_–õ–æ–≥—É–≤–∞–Ω–Ω—è_–í_–Ü–Ω–¥–µ–∫—Å–∞—Ç–æ—Ä')
            if hasattr(mod2, 'search_citations'):
                return mod2.search_citations(query, limit=limit)
        except Exception:
            pass
    # –ó–∞–≥–ª—É—à–∫–∞: –ø–æ–≤–µ—Ä—Ç–∞—î –ø—Ä–∏–∫–ª–∞–¥–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å –±–µ–∑ —Ä–µ–∞–ª—å–Ω–∏—Ö –¥–∂–µ—Ä–µ–ª
    return [{
        'title': '–ó–∞–≥–ª—É—à–∫–∞: –ª–æ–∫–∞–ª—å–Ω–∞ –ë–î –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞',
        'url': '',
        'quote': '–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ —ñ–Ω–¥–µ–∫—Å–æ–≤–∞–Ω–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤. –ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Ñ–∞–π–ª–∏ —Ç–∞ –ø—Ä–æ—ñ–Ω–¥–µ–∫—Å—É–π—Ç–µ —ó—Ö.'
    }]

# ---------------------------------
# –°–ø—Ä–æ–±–∞ —ñ–º–ø–æ—Ä—Ç—É FastAPI ‚Äî –∞–ª–µ —Ç—ñ–ª—å–∫–∏ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –±–ª–æ–∫—É
# ---------------------------------
USE_FASTAPI = False
try:
    import ssl  # –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å ssl ‚Äî —á–∞—Å—Ç–æ —î –ø—Ä–∏—á–∏–Ω–æ—é –ø–æ–º–∏–ª–∫–∏
    from fastapi import FastAPI, Request, Form
    from fastapi.responses import HTMLResponse
    from fastapi.templating import Jinja2Templates
    from fastapi.staticfiles import StaticFiles
    import uvicorn
    USE_FASTAPI = True
except Exception as e:
    # –Ø–∫—â–æ –±—É–¥—å-—è–∫–∏–π —ñ–º–ø–æ—Ä—Ç –Ω–µ –≤–¥–∞–≤—Å—è (ssl –≤—ñ–¥—Å—É—Ç–Ω—ñ–π –∞–±–æ fastapi –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ),
    # –ø–µ—Ä–µ–π–¥–µ–º–æ —É fallback —Ä–µ–∂–∏–º.
    print(f"[INFO] FastAPI –∞–±–æ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ñ ‚Äî –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è fallback HTTP —Å–µ—Ä–≤–µ—Ä. –ü—Ä–∏—á–∏–Ω–∞: {e}", file=sys.stderr)
    USE_FASTAPI = False

# ---------------------------------
# –†–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó –¥–ª—è FastAPI (—è–∫—â–æ –¥–æ—Å—Ç—É–ø–Ω–∏–π)
# ---------------------------------
if USE_FASTAPI:
    app = FastAPI(title="–ê–Ω—Ç–∏–∫–æ—Ä—É–ø—Ü—ñ–π–Ω–∏–π –ß–∞—Ç–ë–æ—Ç ‚Äî –í–µ–±—Å–∞–π—Ç")
    # —Å—Ç–≤–æ—Ä—é—î–º–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó, —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ
    STATIC_DIR.mkdir(parents=True, exist_ok=True)
    TEMPLATES_DIR.mkdir(parents=True, exist_ok=True)
    app.mount('/static', StaticFiles(directory=str(STATIC_DIR)), name='static')
    templates = Jinja2Templates(directory=str(TEMPLATES_DIR))

    @app.get('/', response_class=HTMLResponse)
    async def home(request: Request):
        return templates.TemplateResponse('index.html', { 'request': request, 'title': '–ê–Ω—Ç–∏–∫–æ—Ä—É–ø—Ü—ñ–π–Ω–∏–π —á–∞—Ç–±–æ—Ç' })

    @app.post('/ask', response_class=HTMLResponse)
    async def ask(request: Request, question: str = Form(...)):
        provider = os.getenv('LLM_PROVIDER', 'gemini')
        citations = search_citations_safe(question)
        context = '\n'.join([f"{c['title']} ‚Äî {c['quote']} ({c['url']})" for c in citations])
        prompt = f"–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –ø–∏—Ç–∞—î: {question}\n–ö–æ–Ω—Ç–µ–∫—Å—Ç:\n{context}"
        answer = call_llm_api_safe(prompt, provider=provider)
        return templates.TemplateResponse('index.html', {
            'request': request,
            'title': '–†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø–∏—Ç—É',
            'question': question,
            'answer': answer,
            'sources': citations
        })

    def run_fastapi():
        port = int(os.getenv('PORT', PORT))
        uvicorn.run('–ê–∫—Ç–∏–≤–∞—Ç–æ—Ä_–í–µ–±_–°–∞–π—Ç—É_–ê–Ω—Ç–∏–∫–æ—Ä—É–ø—Ü—ñ—è:app', host='0.0.0.0', port=port, reload=True)

# ---------------------------------
# Fallback: –ø—Ä–æ—Å—Ç–∏–π HTTP —Å–µ—Ä–≤–µ—Ä —è–∫—â–æ FastAPI –Ω–µ–º–∞—î
# ---------------------------------
else:
    from http.server import HTTPServer, BaseHTTPRequestHandler
    import urllib.parse

    INDEX_HTML = TEMPLATES_DIR / 'index.html'
    # –Ø–∫—â–æ —à–∞–±–ª–æ–Ω—É –Ω–µ–º–∞—î ‚Äî —Å—Ç–≤–æ—Ä–∏–º–æ –ø—Ä–æ—Å—Ç–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç
    if not INDEX_HTML.exists():
        TEMPLATES_DIR.mkdir(parents=True, exist_ok=True)
        INDEX_HTML.write_text('''<!doctype html>
<html lang="uk">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>–ê–Ω—Ç–∏–∫–æ—Ä—É–ø—Ü—ñ–π–Ω–∏–π –ß–∞—Ç–ë–æ—Ç ‚Äî (fallback)</title>
</head>
<body>
<h1>üí¨ –ê–Ω—Ç–∏–∫–æ—Ä—É–ø—Ü—ñ–π–Ω–∏–π –ß–∞—Ç–ë–æ—Ç (fallback)</h1>
<form method="post" action="/ask">
<textarea name="question" rows="6" cols="60" placeholder="–í–≤–µ–¥—ñ—Ç—å —Å–≤–æ—î –ø–∏—Ç–∞–Ω–Ω—è..."></textarea><br>
<button type="submit">–ó–∞–ø–∏—Ç–∞—Ç–∏</button>
</form>
</body>
</html>
''', encoding='utf-8')

    class SimpleHandler(BaseHTTPRequestHandler):
        def _send_html(self, html: str, status=200):
            self.send_response(status)
            self.send_header('Content-Type', 'text/html; charset=utf-8')
            self.send_header('Content-Length', str(len(html.encode('utf-8'))))
            self.end_headers()
            self.wfile.write(html.encode('utf-8'))

        def do_GET(self):
            if self.path == '/' or self.path.startswith('/index'):
                html = INDEX_HTML.read_text(encoding='utf-8')
                self._send_html(html)
            else:
                # –ü—Ä–æ—Å—Ç–µ –≤—ñ–¥–¥–∞–≤–∞–Ω–Ω—è —Å—Ç–∞—Ç–∏—á–Ω–∏—Ö —Ñ–∞–π–ª—ñ–≤
                file_path = Path('.') / self.path.lstrip('/')
                if file_path.exists() and file_path.is_file():
                    self.send_response(200)
                    self.send_header('Content-Type', 'application/octet-stream')
                    self.end_headers()
                    with open(file_path, 'rb') as f:
                        self.wfile.write(f.read())
                else:
                    self.send_error(404, 'Not Found')

        def do_POST(self):
            if self.path == '/ask':
                length = int(self.headers.get('Content-Length', 0))
                body = self.rfile.read(length).decode('utf-8')
                data = urllib.parse.parse_qs(body)
                question = data.get('question', [''])[0]
                citations = search_citations_safe(question)
                context = '\n'.join([f"{c['title']} ‚Äî {c['quote']} ({c['url']})" for c in citations])
                prompt = f"–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –ø–∏—Ç–∞—î: {question}\n–ö–æ–Ω—Ç–µ–∫—Å—Ç:\n{context}"
                answer = call_llm_api_safe(prompt)
                # –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –ø—Ä–æ—Å—Ç—É HTML-—Å—Ç–æ—Ä—ñ–Ω–∫—É –∑ –≤—ñ–¥–ø–æ–≤—ñ–¥–¥—é
                result_html = f"""
                <!doctype html>
                <html lang="uk">
                <head><meta charset="utf-8"><title>–†–µ–∑—É–ª—å—Ç–∞—Ç</title></head>
                <body>
                <h1>–í—ñ–¥–ø–æ–≤—ñ–¥—å</h1>
                <p><strong>–ü–∏—Ç–∞–Ω–Ω—è:</strong> {question}</p>
                <h2>–í—ñ–¥–ø–æ–≤—ñ–¥—å –≤—ñ–¥ –º–æ–¥–µ–ª—ñ / –∑–∞–≥–ª—É—à–∫–∏</h2>
                <pre>{answer}</pre>
                <h3>–î–∂–µ—Ä–µ–ª–∞</h3>
                <ul>
                {''.join([f"<li>{c['title']} ‚Äî {c['url']}</li>" for c in citations])}
                </ul>
                <p><a href="/">–ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è</a></p>
                </body></html>
                """
                self._send_html(result_html)
            else:
                self.send_error(404, 'Not Found')

    def run_fallback_server():
        server_address = ('', PORT)
        httpd = HTTPServer(server_address, SimpleHandler)
        print(f"[fallback] HTTP —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω–æ –Ω–∞ –ø–æ—Ä—Ç—É {PORT}")
        try:
            httpd.serve_forever()
        except KeyboardInterrupt:
            print('\n[shutdown] –°–µ—Ä–≤–µ—Ä –∑—É–ø–∏–Ω—è—î—Ç—å—Å—è...')
            httpd.server_close()

# ---------------------------------
# –ó–∞–ø—É—Å–∫ ‚Äî –≤–∏–±—ñ—Ä —Ä–µ–∂–∏–º—É –≤ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –≤—ñ–¥ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—ñ FastAPI
# ---------------------------------
def main():
    if USE_FASTAPI:
        print('[info] –ó–∞–ø—É—Å–∫ —É FastAPI-—Ä–µ–∂–∏–º—ñ')
        # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ uvicorn —Ç—ñ–ª—å–∫–∏ —É –≥–æ–ª–æ–≤–Ω–æ–º—É –ø—Ä–æ—Ü–µ—Å—ñ
        port = int(os.getenv('PORT', PORT))
        # –î–ª—è –∫–æ—Ä–µ–∫—Ç–Ω–æ–≥–æ reload —ñ–º–ø–æ—Ä—Ç—É—î–º–æ –∑–∞ –Ω–∞–∑–≤–æ—é —Ñ–∞–π–ª—É; —É production –º–æ–∂–Ω–∞ –≤–∏–∫–ª–∏–∫–∞—Ç–∏ uvicorn.run(app,...)
        try:
            import uvicorn
            uvicorn.run(app, host='0.0.0.0', port=port)
        except Exception as e:
            print(f"[error] –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç–∏ uvicorn: {e}")
    else:
        print('[info] –ó–∞–ø—É—Å–∫ —É fallback HTTP-—Ä–µ–∂–∏–º—ñ')
        run_fallback_server()

# ---------------------------------
# –¢–µ—Å—Ç–∏ (–ø—Ä–æ—Å—Ç—ñ, –≤–±—É–¥–æ–≤–∞–Ω—ñ)
# ---------------------------------
def _run_self_tests():
    print('\n-- –ó–∞–ø—É—Å–∫ –ø—Ä–æ—Å—Ç–∏—Ö —Ç–µ—Å—Ç—ñ–≤ --')
    # –¢–µ—Å—Ç 1: –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –∑–∞–≥–ª—É—à–∫—É LLM
    sample = call_llm_api_safe('–¢–µ—Å—Ç–æ–≤–∏–π prompt')
    assert isinstance(sample, str)
    print('[test] call_llm_api_safe -> OK')

    # –¢–µ—Å—Ç 2: –ø–æ—à—É–∫ —Ü–∏—Ç–∞—Ç –ø–æ–≤–µ—Ä—Ç–∞—î —Å–ø–∏—Å–æ–∫
    res = search_citations_safe('–∫–æ—Ä—É–ø—Ü—ñ—è')
    assert isinstance(res, list)
    print('[test] search_citations_safe -> OK')

    print('-- –£—Å—ñ —Ç–µ—Å—Ç–∏ –ø—Ä–æ–π–¥–µ–Ω—ñ --\n')

if __name__ == '__main__':
    # –Ø–∫—â–æ –ø–µ—Ä–µ–¥–∞–Ω–æ –∞—Ä–≥—É–º–µ–Ω—Ç --test, –≤–∏–∫–æ–Ω–∞—î–º–æ —Ç–µ—Å—Ç–∏ —ñ –≤–∏–π–¥–µ–º–æ
    if '--test' in sys.argv:
        _run_self_tests()
        sys.exit(0)

    main()
